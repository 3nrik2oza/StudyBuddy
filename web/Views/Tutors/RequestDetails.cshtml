@model web.Models.Entities.TutorRequest
@using System.Security.Claims

@{
    ViewData["Title"] = "Tutoring request";
    var me = User.FindFirstValue(ClaimTypes.NameIdentifier) ?? "";
    var isTutor = Model.TutorUserId == me;
    var otherName = isTutor ? (Model.StudentUser?.Name ?? "Student") : (Model.TutorUser?.Name ?? "Tutor");
    var backAction = isTutor ? "Requests" : "MyRequests";
    var backText = isTutor ? "Back to requests" : "Back to my requests";
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
        <div>
            <h2 class="mb-1">Tutoring request</h2>
            <div class="text-muted">
                <span><b>With:</b> @otherName</span>
                <span class="mx-2">•</span>
                <span><b>Subject:</b> @(Model.Subject?.Name ?? "-")</span>
                <span class="mx-2">•</span>
                <span><b>Status:</b> @Model.Status</span>
            </div>
        </div>

        <a asp-action="@backAction" class="btn btn-outline-secondary btn-sm">@backText</a>
    </div>

    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
            <div class="d-flex flex-column gap-3">
                @foreach (var m in Model.Messages.OrderBy(x => x.SentAt))
                {
                    var mine = (m.SenderUserId == me);
                    <div class="d-flex @(mine ? "justify-content-end" : "justify-content-start")">
                        <div class="p-3 rounded border bg-white" style="max-width: 760px; width: 100%;">
                            <div class="small text-muted mb-1">
                                <b>@(m.SenderUser?.Name ?? "User")</b> • @m.SentAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm")
                            </div>
                            <div style="white-space: pre-wrap;">@m.Body</div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <form asp-action="SendRequestMessage" method="post" class="card border-0 shadow-sm">
        @Html.AntiForgeryToken()
        <input type="hidden" name="id" value="@Model.Id" />
        <div class="card-body">
            <label class="form-label">New message</label>
            <textarea name="body" class="form-control" rows="4" maxlength="2000" placeholder="Write a message..."></textarea>

            <div class="d-flex gap-2 mt-2">
                <button class="btn btn-primary">Send</button>
            </div>
        </div>
    </form>

    @if (isTutor && Model.Status == web.Models.Entities.TutorRequestStatus.Pending)
    {
        <div class="card border-0 shadow-sm mt-3">
            <div class="card-body">
                <h5 class="mb-2">Decision</h5>

                <form asp-action="Decide" method="post" class="d-flex gap-2 flex-wrap align-items-end">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />

                    <div style="min-width:280px; flex:1;">
                        <label class="form-label small mb-1">Optional response message</label>
                        <input name="responseMessage" class="form-control" placeholder="e.g. Friday 16:00 works..." />
                    </div>

                    <button name="accept" value="true" class="btn btn-success">Accept</button>
                    <button name="accept" value="false" class="btn btn-outline-danger">Decline</button>
                </form>
            </div>
        </div>
    }
</div>
