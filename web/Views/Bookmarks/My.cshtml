@using web.Models.Entities
@{
    ViewData["Title"] = "Saved";

    var materials = ViewBag.Materials as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var posts = ViewBag.StudyPosts as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();

    var returnUrl = Context.Request.Path + Context.Request.QueryString;
}

<div class="container py-4">
    <div class="mb-4">
        <h2 class="mb-1">My bookmarks</h2>
        <p class="text-muted mb-0">Your saved materials and study posts.</p>
    </div>

    @if (TempData["ToastMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
            @TempData["ToastMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row g-4">
        <div class="col-12 col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h5 class="mb-0">üìò Materials</h5>
                        <a asp-controller="Materials" asp-action="Index" class="btn btn-outline-secondary btn-sm">Browse</a>
                    </div>

                    @if (!materials.Any())
                    {
                        <div class="text-muted">No saved materials yet.</div>
                    }
                    else
                    {
                        <div class="row g-3">
                            @foreach (var m in materials)
                            {
                                string cardColorClass;
                                string emoji;
                                var subject = (string)(m.SubjectName ?? "");

                                if (subject.Contains("APS", StringComparison.OrdinalIgnoreCase))
                                {
                                    cardColorClass = "material-card-aps";
                                    emoji = "üíª";
                                }
                                else if (subject.Contains("baze", StringComparison.OrdinalIgnoreCase) ||
                                         subject.Contains("db", StringComparison.OrdinalIgnoreCase))
                                {
                                    cardColorClass = "material-card-db";
                                    emoji = "üìä";
                                }
                                else if (subject.Contains("algoritm", StringComparison.OrdinalIgnoreCase))
                                {
                                    cardColorClass = "material-card-algo";
                                    emoji = "‚öôÔ∏è";
                                }
                                else
                                {
                                    cardColorClass = "material-card-default";
                                    emoji = "üìò";
                                }

                                <div class="col-12">
                                    <div class="material-card @cardColorClass">
                                        <div class="material-card-icon">@emoji</div>

                                        <div class="material-card-header text-muted small fw-semibold">
                                            @(string.IsNullOrWhiteSpace(subject) ? "Subject" : subject)
                                        </div>

                                        <h6 class="mt-3 mb-1">@m.Title</h6>

                                        <div class="d-flex justify-content-between align-items-center mt-auto">
                                            @if (!string.IsNullOrWhiteSpace((string)(m.Type ?? "")))
                                            {
                                                <span class="material-type-badge">@m.Type</span>
                                            }
                                            else
                                            {
                                                <span></span>
                                            }

                                            <div class="d-flex gap-2 align-items-center">
                                                <form asp-controller="Bookmarks" asp-action="Toggle" method="post" class="m-0">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="type" value="@((int)BookmarkType.Material)" />
                                                    <input type="hidden" name="entityId" value="@m.Id" />
                                                    <input type="hidden" name="returnUrl" value="@returnUrl" />
                                                    <button type="submit" class="btn btn-outline-danger btn-sm">Remove</button>
                                                </form>

                                                @if (!string.IsNullOrWhiteSpace((string)(m.Url ?? "")))
                                                {
                                                    <a href="@m.Url" target="_blank" rel="noopener" class="btn btn-outline-primary btn-sm">
                                                        Open link
                                                    </a>
                                                }
                                                else
                                                {
                                                    <span class="text-muted small">No link</span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h5 class="mb-0">üìÖ Study posts</h5>
                        <a asp-controller="StudyPosts" asp-action="Index" class="btn btn-outline-secondary btn-sm">Browse</a>
                    </div>

                    @if (!posts.Any())
                    {
                        <div class="text-muted">No saved study posts yet.</div>
                    }
                    else
                    {
                        <div class="row g-3">
                            @foreach (var t in posts)
                            {
                                string imageUrl;
                                var subjectName = (string)(t.SubjectName ?? "");

                                if (subjectName.Contains("APS", StringComparison.OrdinalIgnoreCase))
                                    imageUrl = "https://images.pexels.com/photos/1181675/pexels-photo-1181675.jpeg";
                                else if (subjectName.Contains("IS", StringComparison.OrdinalIgnoreCase))
                                    imageUrl = "https://images.pexels.com/photos/3861964/pexels-photo-3861964.jpeg";
                                else
                                    imageUrl = "https://images.pexels.com/photos/4145190/pexels-photo-4145190.jpeg";

                                <div class="col-12">
                                    <div class="session-card card h-100 border-0 shadow-sm">
                                        <div class="ratio ratio-16x9 session-card-cover">
                                            <img src="@imageUrl" class="card-img-top" alt="Study post image for @subjectName" />
                                        </div>

                                        <div class="card-body d-flex flex-column">
                                            <div class="d-flex justify-content-between align-items-start gap-2">
                                                <span class="badge bg-light text-secondary">
                                                    @(string.IsNullOrWhiteSpace(subjectName) ? "Subject" : subjectName)
                                                </span>

                                                <form asp-controller="Bookmarks" asp-action="Toggle" method="post" class="m-0">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="type" value="@((int)BookmarkType.StudyPost)" />
                                                    <input type="hidden" name="entityId" value="@t.Id" />
                                                    <input type="hidden" name="returnUrl" value="@returnUrl" />
                                                    <button type="submit" class="btn btn-outline-danger btn-sm">Remove</button>
                                                </form>
                                            </div>

                                            <h6 class="card-title mt-2 mb-1">@t.Title</h6>

                                            <p class="card-text text-muted small mb-3">
                                                @(((DateTime)t.StartAt).ToLocalTime().ToString("dd.MM.yyyy HH:mm")) ¬∑ @t.Location
                                            </p>

                                            <div class="mt-auto d-flex justify-content-between align-items-center">
                                                @if ((bool)t.IsOnline)
                                                {
                                                    <span class="session-type-badge session-type-online">Online</span>
                                                }
                                                else
                                                {
                                                    <span class="session-type-badge session-type-physical">On campus</span>
                                                }

                                                <a asp-controller="StudyPosts" asp-action="Details" asp-route-id="@t.Id" class="btn btn-outline-primary btn-sm">
                                                    Open
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
