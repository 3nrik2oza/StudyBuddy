@page
@model web.Areas.Identity.Pages.Account.ProfileModel
@{
    ViewData["Title"] = "Your Profile";
}

<div class="container py-4">

    @if (TempData["StatusMessage"] != null)
    {
        <div class="alert alert-success">@TempData["StatusMessage"]</div>
    }

    <h2>Your Profile</h2>
    <hr />

    <form method="post" asp-page-handler="UpdateProfile">
        <h4>Account Information</h4>
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

        <!-- Name -->
        <div class="form-floating mb-3">
            <input asp-for="Input.Name" class="form-control" />
            <label asp-for="Input.Name"></label>
            <span asp-validation-for="Input.Name" class="text-danger"></span>
        </div>

        <!-- Email (read only for now) -->
        <div class="form-floating mb-3">
            <input asp-for="Input.Email" class="form-control" readonly />
            <label asp-for="Input.Email"></label>
        </div>

        <!-- Description -->
        <div class="form-floating mb-3">
            <textarea asp-for="Input.Description" class="form-control" style="height:100px"></textarea>
            <label asp-for="Input.Description"></label>
            <span asp-validation-for="Input.Description" class="text-danger"></span>
        </div>

        <!-- Faculty -->
        <div class="form-floating mb-3">
            <select asp-for="Input.FacultyId" asp-items="Model.FacultyOptions" class="form-control"></select>
            <label asp-for="Input.FacultyId">Faculty</label>
            <span asp-validation-for="Input.FacultyId" class="text-danger"></span>
        </div>

        <!-- Tutor toggle -->
        <div class="form-check mb-3">
            <input asp-for="Input.IsTutor" class="form-check-input" id="isTutorCheckbox" />
            <label asp-for="Input.IsTutor" class="form-check-label">Registered as Tutor</label>
        </div>

        <!-- Subjects for tutors -->
        <div id="tutorSubjectsSection" style="display:none;">
            <label class="fw-bold">Subjects You Teach</label>

            <!-- Subject selector row -->
            <div class="d-flex gap-2 align-items-center my-2">
                <select id="availableSubjects" class="form-control">
                    <option value="">-- Select Subject --</option>
                    @foreach (var s in Model.SubjectOptions)
                    {
                        if (!Model.Input.SubjectIds.Contains(int.Parse(s.Value)))
                        {
                            <option value="@s.Value">@s.Text</option>
                        }
                    }
                </select>

                <button type="button" id="addSubjectBtn" class="btn btn-secondary">Add</button>
            </div>

            <!-- Selected subjects -->
            <div id="selectedSubjectsContainer">
                @foreach (var subjectId in Model.Input.SubjectIds)
                {
                    var subject = Model.SubjectOptions.FirstOrDefault(o => o.Value == subjectId.ToString());
                    if (subject != null)
                    {
                        <div class="d-flex justify-content-between align-items-center border p-2 mb-2"
                             data-id="@subjectId">
                            <span>@subject.Text</span>
                            <button type="button" class="btn btn-danger btn-sm remove-subject-btn">Remove</button>

                            <!-- Hidden input -->
                            <input type="hidden" name="Input.SubjectIds" value="@subjectId" />
                        </div>
                    }
                }
            </div>

            <div id="hiddenInputs"></div>
        </div>

        <button class="btn btn-primary mt-3">Save Profile</button>
    </form>

    <hr />

    <!-- Change Password -->
    <h4>Change Password</h4>
    <form method="post" asp-page-handler="ChangePassword">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

        <div class="form-floating mb-3">
            <input asp-for="Input.CurrentPassword" class="form-control" type="password" />
            <label asp-for="Input.CurrentPassword"></label>
        </div>

        <div class="form-floating mb-3">
            <input asp-for="Input.NewPassword" class="form-control" type="password" />
            <label asp-for="Input.NewPassword"></label>
        </div>

        <div class="form-floating mb-3">
            <input asp-for="Input.ConfirmPassword" class="form-control" type="password" />
            <label asp-for="Input.ConfirmPassword"></label>
        </div>

        <button class="btn btn-warning">Change Password</button>
    </form>

    <hr />

    <!-- User Study Sessions -->
    <h3>Your Study Sessions</h3>

    @if (Model.UserStudyPosts.Count == 0)
    {
        <p class="text-muted">You haven't created any study sessions yet.</p>
    }
    else
    {
        <div class="list-group mb-4">
            @foreach (var p in Model.UserStudyPosts)
            {
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>@p.Title</strong><br />
                        <small>@p.Subject?.Name • @p.Faculty?.Name</small><br />
                        <small class="text-muted">@p.CreatedAt.ToLocalTime()</small>
                    </div>

                    <form method="post" asp-page-handler="DeleteStudyPost" class="ms-3">
                        <input type="hidden" name="id" value="@p.Id" />
                        <button class="btn btn-danger btn-sm"
                                onclick="return confirm('Delete this study session?')">
                            Delete
                        </button>
                    </form>
                </div>
            }
        </div>
    }

    <!-- User Materials -->
    <h3>Your Materials</h3>

    @if (Model.UserMaterials.Count == 0)
    {
        <p class="text-muted">You haven't uploaded any materials yet.</p>
    }
    else
    {
        <div class="list-group">
            @foreach (var m in Model.UserMaterials)
            {
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>@m.Title</strong><br />
                        <small>@m.Type • @m.Subject?.Name • @m.Faculty?.Name</small><br />
                        <small class="text-muted">@m.CreatedAt.ToLocalTime()</small>
                    </div>

                    <form method="post" asp-page-handler="DeleteMaterial" class="ms-3">
                        <input type="hidden" name="id" value="@m.Id" />
                        <button class="btn btn-danger btn-sm"
                                onclick="return confirm('Delete this material?')">
                            Delete
                        </button>
                    </form>
                </div>
            }
        </div>
    }

</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        const isTutorCheckbox = document.getElementById("isTutorCheckbox");
        const tutorSection = document.getElementById("tutorSubjectsSection");
        const availableSubjects = document.getElementById("availableSubjects");
        const addSubjectBtn = document.getElementById("addSubjectBtn");
        const selectedContainer = document.getElementById("selectedSubjectsContainer");
        const hiddenInputs = document.getElementById("hiddenInputs");

        function toggleTutorSection() {
            tutorSection.style.display = isTutorCheckbox.checked ? "block" : "none";
        }

        toggleTutorSection();
        isTutorCheckbox.addEventListener("change", toggleTutorSection);

        function addSubject() {
            const subjectId = availableSubjects.value;
            const subjectName = availableSubjects.options[availableSubjects.selectedIndex].text;

            if (!subjectId) return;

            availableSubjects.remove(availableSubjects.selectedIndex);

            const row = document.createElement("div");
            row.className = "d-flex justify-content-between align-items-center border p-2 mb-2";
            row.dataset.id = subjectId;

            row.innerHTML = `
                <span>${subjectName}</span>
                <button type="button" class="btn btn-danger btn-sm remove-subject-btn">Remove</button>
                <input type="hidden" name="Input.SubjectIds" value="${subjectId}" />
            `;

            row.querySelector(".remove-subject-btn").addEventListener("click", () => {
                row.remove();
                const opt = document.createElement("option");
                opt.value = subjectId;
                opt.text = subjectName;
                availableSubjects.appendChild(opt);
            });

            selectedContainer.appendChild(row);
            availableSubjects.value = "";
        }

        addSubjectBtn.addEventListener("click", addSubject);

        // Remove existing subject items
        document.querySelectorAll(".remove-subject-btn").forEach(btn => {
            btn.addEventListener("click", function () {
                const row = this.closest("[data-id]");
                const id = row.dataset.id;
                const name = row.querySelector("span").innerText;

                row.remove();

                const opt = document.createElement("option");
                opt.value = id;
                opt.text = name;
                availableSubjects.appendChild(opt);
            });
        });
    </script>
}
